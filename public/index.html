<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Quiz Live — Joueur (Interactive)</title>
  <script src="/socket.io/socket.io.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    .btn:disabled{opacity:0.7; cursor:not-allowed;}
    .pulse{animation:pulse 1s ease-in-out 2}
    @keyframes pulse{0%{transform:scale(1)}50%{transform:scale(1.03)}100%{transform:scale(1)}}
  </style>
</head>
<body class="min-h-screen bg-gradient-to-b from-slate-100 to-slate-200">
  <div class="max-w-xl mx-auto p-6">
    <header class="flex items-center justify-between mb-4">
      <h1 class="text-2xl font-bold">Quiz Live — Joueur</h1>
      <a href="/host" class="text-sm text-slate-600 underline hover:no-underline">Mode animateur</a>
    </header>

    <!-- Join -->
    <div id="join" class="space-y-3 bg-white rounded-2xl shadow p-4">
      <input id="pin" class="w-full border p-3 rounded" placeholder="Code PIN (6 chiffres)" />
      <input id="name" class="w-full border p-3 rounded" placeholder="Votre nom" />
      <button id="joinBtn" class="btn w-full bg-blue-600 text-white rounded p-3 font-semibold hover:bg-blue-700">Rejoindre</button>
      <p id="joinMsg" class="text-sm text-red-600"></p>
    </div>

    <!-- Lobby -->
    <div id="lobby" class="hidden mt-8 bg-white rounded-2xl shadow p-4">
      <p class="text-gray-700">Connecté ✅ En attente de la première question…</p>
    </div>

    <!-- Question -->
    <div id="question" class="hidden mt-8 bg-white rounded-2xl shadow p-4">
      <div class="text-sm text-gray-500" id="qProgress"></div>
      <h2 id="qText" class="text-xl font-semibold mb-3"></h2>
      <div class="flex items-center justify-between mb-3">
        <div id="timer" class="text-gray-700"></div>
        <div id="deadline" class="text-gray-500 text-sm"></div>
      </div>
      <div id="options" class="grid grid-cols-1 gap-3"></div>
      <p id="answerMsg" class="mt-3 text-sm"></p>
    </div>

    <!-- Result -->
    <div id="result" class="hidden mt-6 bg-white rounded-2xl shadow p-4">
      <h3 class="text-lg font-semibold mb-2">Résultat</h3>
      <p id="correctMsg" class="mb-2"></p>
      <p id="scoreMsg" class="text-gray-700"></p>
      <p id="deltaMsg" class="text-gray-600 text-sm"></p>
    </div>

    <!-- End -->
    <div id="end" class="hidden mt-8 bg-white rounded-2xl shadow p-4">
      <h2 class="text-2xl font-bold mb-2">Quiz terminé!</h2>
      <p class="text-gray-700">Merci d’avoir participé.</p>
    </div>
  </div>

  <script>
    const socket = io();
    let currentRoom = null;
    let me = { name: null, score: 0 };
    let endAt = null;
    let rafId = null;
    let hasAnswered = false;
    let myChoiceIndex = null;

    const $ = (id)=>document.getElementById(id);
    const joinEl = $('join'), lobbyEl = $('lobby'), qEl = $('question'), endEl = $('end');
    const optionsEl = $('options');
    const qText = $('qText'), qProg = $('qProgress'), qTimer = $('timer'), deadlineEl = $('deadline');
    const answerMsg = $('answerMsg'), resultEl = $('result');

    function fmtMs(ms) {
      const s = Math.max(0, Math.ceil(ms / 1000));
      return s + 's';
    }
    function loopTimer() {
      if (!endAt) return;
      const ms = endAt - Date.now();
      qTimer.textContent = 'Temps restant : ' + fmtMs(ms);
      if (ms > 0) rafId = requestAnimationFrame(loopTimer);
    }

    function lockChoices() {
      const btns = optionsEl.querySelectorAll('button');
      btns.forEach((b, idx)=>{
        b.disabled = true;
        b.classList.add('opacity-70');
        if (idx === myChoiceIndex) {
          b.classList.remove('bg-white','hover:bg-gray-50','border');
          b.className = 'btn w-full rounded p-3 font-semibold bg-emerald-500 text-white pulse';
        }
      });
    }

    $('joinBtn').onclick = () => {
      const pin = $('pin').value.trim();
      const name = $('name').value.trim();
      if (!pin || !/^\d{6}$/.test(pin)) { $('joinMsg').textContent = 'PIN invalide'; return; }
      if (!name) { $('joinMsg').textContent = 'Entrez un nom'; return; }
      $('joinMsg').textContent = '';
      socket.emit('player:join', { roomCode: pin, name });
    };

    socket.on('player:error', msg => { $('joinMsg').textContent = msg; });

    socket.on('player:joined', ({ roomCode, name }) => {
      currentRoom = roomCode; me.name = name;
      joinEl.classList.add('hidden'); lobbyEl.classList.remove('hidden');
    });

    socket.on('room:question', ({ index, total, question, options, time, endAt: end }) => {
      lobbyEl.classList.add('hidden'); resultEl.classList.add('hidden');
      qEl.classList.remove('hidden'); endEl.classList.add('hidden');
      qProg.textContent = `Question ${index+1} / ${total}`;
      qText.textContent = question;
      optionsEl.innerHTML = '';
      hasAnswered = false;
      myChoiceIndex = null;

      options.forEach((opt, i) => {
        const btn = document.createElement('button');
        btn.className = 'btn w-full border rounded p-3 bg-white hover:bg-gray-50 text-left';
        btn.innerHTML = `<span class="font-semibold mr-2">${'ABCD'[i]}.</span> ${opt}`;
        btn.onclick = () => {
          if (hasAnswered) return;
          hasAnswered = true;
          myChoiceIndex = i;
          socket.emit('player:answer', { roomCode: currentRoom, choiceIndex: i });
          answerMsg.textContent = 'Réponse enregistrée ✅';
          lockChoices();
          window.navigator.vibrate?.(50);
        };
        optionsEl.appendChild(btn);
      });

      endAt = end;
      deadlineEl.textContent = new Date(endAt).toLocaleTimeString();
      if (rafId) cancelAnimationFrame(rafId);
      rafId = requestAnimationFrame(loopTimer);
      answerMsg.textContent = '';
    });

    socket.on('room:reveal', ({ correctIndex, perPlayer }) => {
      const prev = me.score;
      const meStats = perPlayer.find(p => p.name === me.name);
      me.score = meStats?.score ?? me.score;
      const earned = me.score - prev;

      resultEl.classList.remove('hidden');
      const good = (myChoiceIndex !== null && myChoiceIndex === correctIndex);
      $('correctMsg').textContent = good ? '✅ Bonne réponse !' : '❌ Mauvaise réponse.';
      $('scoreMsg').textContent = `Votre score : ${me.score} pts`;
      $('deltaMsg').textContent = `+${earned > 0 ? earned : 0} pt${(earned > 1) ? 's' : ''}`;

      if (myChoiceIndex !== null && myChoiceIndex !== correctIndex) {
        const btns = optionsEl.querySelectorAll('button');
        const b = btns[myChoiceIndex];
        if (b) {
          b.className = 'btn w-full rounded p-3 font-semibold bg-rose-500 text-white';
        }
      }
    });

    socket.on('room:ended', () => {
      qEl.classList.add('hidden'); resultEl.classList.add('hidden'); endEl.classList.remove('hidden');
    });

    socket.on('room:gameOver', ({ leaderboard }) => {
      qEl.classList.add('hidden');
      resultEl.classList.add('hidden');
      endEl.classList.remove('hidden');
    });
  </script>
</body>
</html>
