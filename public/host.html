<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Quiz Live — Animateur (Focus)</title>
  <script src="/socket.io/socket.io.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="min-h-screen bg-slate-950 text-slate-100">
  <div class="max-w-7xl mx-auto p-4 md:p-6 space-y-4">
    <header class="flex items-center justify-between gap-3">
      <div class="flex items-center gap-3">
        <button id="createRoom" class="bg-emerald-600 hover:bg-emerald-700 rounded px-4 py-2 font-semibold">Créer un salon</button>
        <button id="loadBtn" class="bg-blue-600 hover:bg-blue-700 rounded px-4 py-2 font-semibold">Charger JSON/CSV</button>
      </div>
      <div class="text-sm text-slate-300">PIN: <span id="pin" class="font-mono text-xl"></span></div>
    </header>

    <main class="grid grid-rows-[auto_auto_1fr] gap-4">
      <section class="grid md:grid-cols-4 gap-4">
        <div class="bg-slate-900/60 rounded-2xl p-4 flex flex-col gap-2">
          <h2 class="font-semibold">Contrôles</h2>
          <button id="nextBtn" class="w-full bg-indigo-600 hover:bg-indigo-700 rounded p-3 font-semibold">Question suivante ▶</button>
          <button id="revealBtn" class="w-full bg-amber-600 hover:bg-amber-700 rounded p-3 font-semibold">Révéler ✅</button>
          <button id="exportBtn" class="w-full bg-teal-600 hover:bg-teal-700 rounded p-3 font-semibold disabled:opacity-50" disabled>Exporter scores (CSV)</button>
        </div>
        <div class="bg-slate-900/60 rounded-2xl p-4 flex flex-col gap-2 md:col-span-2">
          <h2 class="font-semibold">Statut de la question</h2>
          <div class="flex items-center justify-between">
            <div>
              <div class="text-sm">Participants : <span id="playersCount" class="font-semibold">0</span></div>
              <div class="text-sm">Réponses reçues : <span id="answeredCount" class="font-semibold">0</span></div>
            </div>
            <div class="text-right">
              <div class="text-sm">Temps restant</div>
              <div id="timer" class="text-2xl font-mono">--s</div>
              <div id="deadline" class="text-xs text-slate-400"></div>
            </div>
          </div>
          <div id="progressBar" class="h-2 bg-slate-800 rounded overflow-hidden">
            <div id="progressFill" class="h-2 bg-indigo-500" style="width:0%"></div>
          </div>
        </div>
        <div class="bg-slate-900/60 rounded-2xl p-4">
          <h2 class="font-semibold">Import</h2>
          <textarea id="quizJson" rows="4" class="w-full p-2 rounded bg-slate-800 border border-slate-700 font-mono text-xs" placeholder='[{"question":"…","options":["A","B","C","D"],"correctIndex":1,"time":20,"explanation":"Indice..."}]'></textarea>
          <div class="flex items-center gap-2 mt-2">
            <input id="csvFile" type="file" accept=".csv" class="text-xs" />
            <button id="loadQuiz" class="bg-blue-600 hover:bg-blue-700 rounded px-3 py-2 text-sm font-semibold">Charger</button>
          </div>
          <p id="quizStatus" class="text-xs text-slate-300 mt-2"></p>
        </div>
      </section>

      <section class="bg-slate-900/60 rounded-2xl p-4">
        <div class="flex items-start justify-between gap-4">
          <div>
            <h3 class="font-semibold mb-2">Question en cours</h3>
            <div id="qtext" class="text-xl mb-2 text-slate-100"></div>
            <ol id="optlist" class="list-none grid md:grid-cols-2 gap-2"></ol>
            <p id="explaBadge" class="hidden mt-3 text-slate-300 italic"></p>
          </div>
          <div class="text-right"><div id="qProgress" class="text-sm text-slate-300"></div></div>
        </div>
      </section>

      <section class="bg-slate-900/60 rounded-2xl p-4">
        <h3 class="font-semibold mb-2">Réponses</h3>
        <div id="liveOnly" class="text-slate-200">
          <p class="text-lg">Réponses reçues : <span id="answeredOnly" class="font-mono">0</span> / <span id="playersOnly" class="font-mono">0</span></p>
        </div>
        <div id="afterReveal" class="hidden">
          <div class="grid grid-cols-4 gap-3" id="countGrid"></div>
          <p id="correctMsg" class="mt-3 text-emerald-400 font-semibold"></p>
        </div>
      </section>
    </main>
  </div>

  <script>
    const socket = io();
    let roomCode = null;
    let accepting = false;
    let endAt = null;
    let rafId = null;
    let currentQ = { question: '', options: [], time: 20000 };

    const $ = id => document.getElementById(id);
    const playersCount = $('playersCount');
    const answeredCount = $('answeredCount');
    const timerEl = $('timer');
    const deadlineEl = $('deadline');
    const progressFill = $('progressFill');
    const answeredOnly = $('answeredOnly');
    const playersOnly = $('playersOnly');
    const afterReveal = $('afterReveal');
    const liveOnly = $('liveOnly');
    const countGrid = $('countGrid');

    function fmtMs(ms){ const s = Math.max(0, Math.ceil(ms/1000)); return s + 's'; }
    function loopTimer(){
      if (!endAt) return;
      const ms = endAt - Date.now();
      timerEl.textContent = fmtMs(ms);
      deadlineEl.textContent = new Date(endAt).toLocaleTimeString();
      const total = currentQ.time || 20000;
      const elapsed = Math.max(0, Math.min(total, total - Math.max(0, ms)));
      progressFill.style.width = (elapsed/total*100) + '%';
      if (ms > 0 && accepting) rafId = requestAnimationFrame(loopTimer);
    }
    function setCounts(totals){
      if (!totals) return;
      playersCount.textContent = totals.players ?? 0;
      answeredCount.textContent = totals.answered ?? 0;
      playersOnly.textContent = totals.players ?? 0;
      answeredOnly.textContent = totals.answered ?? 0;
    }

    // buttons
    $('createRoom').onclick = () => socket.emit('host:createRoom');
    $('nextBtn').onclick = () => roomCode && socket.emit('host:nextQuestion', { roomCode });
    $('revealBtn').onclick = () => roomCode && socket.emit('host:reveal', { roomCode });
    $('exportBtn').onclick = () => {
      if (!roomCode) return;
      const a = document.createElement('a');
      a.href = `/export/${roomCode}`;
      a.download = `scores_${roomCode}.csv`;
      document.body.appendChild(a); a.click(); a.remove();
    };
    $('loadBtn').onclick = () => { window.scrollTo({ top: 0, behavior: 'smooth' }); $('quizJson').focus(); };
    $('loadQuiz').onclick = async () => {
      if (!roomCode) { alert('Crée d’abord un salon.'); return; }
      const csvInput = $('csvFile').files[0];
      if (csvInput) {
        const text = await csvInput.text();
        try {
          const quiz = parseCSVToQuiz(text);
          if (!quiz.length) throw new Error('CSV vide/mal formé');
          socket.emit('host:loadQuiz', { roomCode, quiz });
        } catch(e){ $('quizStatus').textContent = 'Erreur CSV : ' + e.message; }
      } else {
        try {
          const quiz = JSON.parse($('quizJson').value);
          socket.emit('host:loadQuiz', { roomCode, quiz });
        } catch(e){ $('quizStatus').textContent = 'JSON invalide.'; }
      }
    };

    function parseCSVToQuiz(csvText){
      const rows=[]; let i=0, field='', row=[], inQuotes=false;
      const pushField=()=>{ row.push(field); field=''; };
      const pushRow=()=>{ rows.push(row); row=[]; };
      while(i<csvText.length){
        const c = csvText[i];
        if(inQuotes){
          if(c === '"'){ if(csvText[i+1] === '"'){ field+='"'; i++; } else { inQuotes=false; } }
          else { field += c; }
        } else {
          if(c === '"'){ inQuotes=true; }
          else if(c === ','){ pushField(); }
          else if(c === '\n'){ pushField(); pushRow(); }
          else if(c === '\r'){}
          else { field += c; }
        }
        i++;
      }
      if(field.length || row.length){ pushField(); pushRow(); }
      while(rows.length && rows[rows.length-1].every(v=>v.trim()==='')) rows.pop();
      if(!rows.length) return [];
      const headers = rows[0].map(h=>h.trim().toLowerCase());
      const idx = {question:headers.indexOf('question'),a:headers.indexOf('option_a'),b:headers.indexOf('option_b'),c:headers.indexOf('option_c'),d:headers.indexOf('option_d'),correct:headers.indexOf('correct'),time:headers.indexOf('time'),explanation:headers.indexOf('explanation')};
      if ([idx.question, idx.a, idx.b, idx.c, idx.d, idx.correct].some(v=>v===-1)) throw new Error('En-têtes requis: question, option_a, option_b, option_c, option_d, correct[, time, explanation]');
      const quiz = [];
      for (let r=1;r<rows.length;r++){
        const cols = rows[r];
        const q = (cols[idx.question]||'').trim();
        const opts = [cols[idx.a],cols[idx.b],cols[idx.c],cols[idx.d]].map(v=>(v||'').trim());
        if(!q || opts.some(o=>!o)) continue;
        let correctRaw = (cols[idx.correct]||'').trim();
        let correctIndex = /^[0-3]$/.test(correctRaw) ? parseInt(correctRaw,10) : ({A:0,B:1,C:2,D:3}[correctRaw.toUpperCase()]);
        if (correctIndex == null || correctIndex < 0 || correctIndex > 3) continue;
        let time = 20;
        if (idx.time !== -1) { const t = parseInt((cols[idx.time]||'').trim(), 10); if (!isNaN(t) && t > 0) time = t; }
        const explanation = (idx.explanation !== -1 ? (cols[idx.explanation]||'').trim() : '');
        quiz.push({ question:q, options:opts, correctIndex, time, explanation });
      }
      return quiz;
    }

    // sockets
    socket.on('host:roomCreated', (pin) => { roomCode = pin; document.getElementById('pin').textContent = pin; document.getElementById('exportBtn').disabled = false; document.getElementById('quizStatus').textContent = 'Salon créé — chargez un JSON ou un CSV.'; });
    socket.on('room:quizLoaded', ({ count }) => { document.getElementById('quizStatus').textContent = `Questionnaire chargé (${count} questions).`; });

    socket.on('host:status', ({ totals, accepting: isAccepting, endAt: e }) => {
      accepting = !!isAccepting; if (e) endAt = e;
      setCounts(totals);
      if (accepting) { if (rafId) cancelAnimationFrame(rafId); rafId = requestAnimationFrame(loopTimer); liveOnly.classList.remove('hidden'); afterReveal.classList.add('hidden'); }
    });

    socket.on('room:question', ({ index, total, question, options, time, endAt: e, totals }) => {
      currentQ = { question, options, time: (time||20)*1000 };
      document.getElementById('qtext').textContent = `Q${index+1}/${total} — ${question}`;
      document.getElementById('qProgress').textContent = `Question ${index+1} / ${total}`;
      document.getElementById('optlist').innerHTML = options.map((opt,i)=>`
        <li id="opt${i}" class="px-3 py-2 rounded bg-slate-800/70 border border-slate-700">
          <span class="font-semibold text-slate-200 mr-2">${'ABCD'[i]}.</span>
          <span class="text-slate-200">${opt}</span>
        </li>`).join('');
      accepting = true; endAt = e; setCounts(totals);
      if (rafId) cancelAnimationFrame(rafId); rafId = requestAnimationFrame(loopTimer);
      liveOnly.classList.remove('hidden'); afterReveal.classList.add('hidden'); document.getElementById('countGrid').innerHTML = ''; document.getElementById('correctMsg').textContent=''; document.getElementById('explaBadge').classList.add('hidden'); document.getElementById('explaBadge').textContent='';
    });

    socket.on('room:reveal', ({ correctIndex, explanation }) => {
      accepting = false; if (rafId) cancelAnimationFrame(rafId);
      for (let i=0;i<4;i++){ const li = document.getElementById('opt'+i); if (li){ li.classList.remove('ring-2','ring-emerald-400','border-emerald-500'); if (i===correctIndex) li.classList.add('ring-2','ring-emerald-400','border-emerald-500'); } }
      if (explanation && explanation.trim()){ const e = document.getElementById('explaBadge'); e.textContent = explanation.trim(); e.classList.remove('hidden'); }
    });

    socket.on('host:counts', ({ counts, correctIndex, totals }) => {
      setCounts(totals);
      liveOnly.classList.add('hidden'); afterReveal.classList.remove('hidden');
      countGrid.innerHTML = counts.map((n,i)=>`
        <div class="rounded-xl bg-slate-800 border border-slate-700 p-4 text-center ${i===correctIndex?'ring-2 ring-emerald-400':''}">
          <div class="text-sm text-slate-400 mb-1">${'ABCD'[i]}</div>
          <div class="text-3xl font-mono">${n}</div>
        </div>`).join('');
      document.getElementById('correctMsg').textContent = `Bonne réponse : ${'ABCD'[correctIndex]}`;
    });
  </script>
</body>
</html>
